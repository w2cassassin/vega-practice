<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.9.3/css/bulma.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
    />
    <title>Сравнение расписаний</title>
    <style>
      #loading {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      #loading .spinner {
        font-size: 3rem;
      }
      .pair-selectors {
        display: flex;
        gap: 1rem;
        align-items: center;
        margin-bottom: 1rem;
      }
      .pair-and-result {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        flex-wrap: wrap;
      }
      .selectors-box {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        flex: 1;
        min-width: 300px;
      }
      .select {
        width: 100%;
        max-width: 100%;
      }

      .select select {
        width: 100%;
        box-sizing: border-box;
      }
      .delete-pair-button {
        align-self: center;
      }
      .comparison-table {
        margin-top: 2rem;
      }
    </style>
  </head>
  <body>
    <section class="section">
      <div class="container">
        <h1 class="title">Сравнение расписаний</h1>

        <div class="box">
          <h2 class="subtitle">Загрузка файла</h2>
          <form id="uploadForm">
            <div class="field">
              <div class="file has-name">
                <label class="file-label">
                  <input
                    class="file-input"
                    type="file"
                    id="fileInput"
                    required
                  />
                  <span class="file-cta">
                    <span class="file-icon">
                      <i class="fas fa-upload"></i>
                    </span>
                    <span class="file-label"> Выберите файл… </span>
                  </span>
                  <span class="file-name" id="fileName">Файл не выбран</span>
                </label>
              </div>
            </div>
            <div class="field">
              <button type="submit" class="button is-primary">Загрузить</button>
            </div>
          </form>
        </div>

        <div class="box">
          <h2 class="subtitle">Доступные файлы</h2>
          <button id="refreshFiles" class="button is-info mb-4">
            Обновить список файлов
          </button>
          <div id="fileList" class="table-container">
            <table class="table is-fullwidth">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Название</th>
                  <th>Дата создания</th>
                  <th>Действия</th>
                </tr>
              </thead>
              <tbody id="filesTableBody">
                <!-- File rows will be populated here -->
              </tbody>
            </table>
          </div>
        </div>

        <div class="box">
          <h2 class="subtitle">Сравнение файлов</h2>
          <form id="compareForm">
            <div class="selectors-box" id="selectorsContainer">
              <div class="pair-and-result">
                <div class="pair-selectors">
                  <div class="control">
                    <div class="select">
                      <select class="fileSelect1" required>
                        <!-- File options will be populated here -->
                      </select>
                    </div>
                  </div>
                  <div class="control">
                    <div class="select">
                      <select class="fileSelect2" required>
                        <!-- File options will be populated here -->
                      </select>
                    </div>
                  </div>
                  <button
                    type="button"
                    class="button is-danger is-light delete-pair-button"
                  >
                    Удалить
                  </button>
                </div>
              </div>
            </div>
            <div class="field">
              <button type="button" id="addPairButton" class="button is-info">
                Добавить еще пару
              </button>
            </div>
            <div class="field">
              <button
                type="submit"
                id="compareButton"
                class="button is-primary"
              >
                Сравнить файлы
              </button>
            </div>
          </form>
        </div>

        <div
          id="comparisonResultsContainer"
          class="box comparison-table"
          style="display: none"
        >
          <h2 class="subtitle">Результаты сравнения</h2>
          <table class="table is-fullwidth">
            <thead>
              <tr>
                <th>Количество изменений</th>
                <!-- Pair headers will be populated here -->
                <th>Итоговые изменения</th>
              </tr>
            </thead>
            <tbody id="comparisonResultsBody">
              <!-- Comparison results will be populated here -->
            </tbody>
          </table>
        </div>
      </div>
    </section>
    <div id="loading" class="has-text-centered">
      <div class="spinner">
        <i class="fas fa-spinner fa-pulse"></i>
      </div>
      <p>Идет сравнение файлов, пожалуйста, подождите...</p>
    </div>
    <script>
      const API_HOST = "{{ api_url }}";

      const fileInput = document.getElementById("fileInput");
      const fileName = document.getElementById("fileName");
      const filesTableBody = document.getElementById("filesTableBody");
      const uploadForm = document.getElementById("uploadForm");
      const compareForm = document.getElementById("compareForm");
      const compareButton = document.getElementById("compareButton");
      const refreshFiles = document.getElementById("refreshFiles");
      const loadingIndicator = document.getElementById("loading");
      const selectorsContainer = document.getElementById("selectorsContainer");
      const addPairButton = document.getElementById("addPairButton");
      const comparisonResultsContainer = document.getElementById(
        "comparisonResultsContainer"
      );
      const comparisonResultsBody = document.getElementById(
        "comparisonResultsBody"
      );

      let pairs = [];

      // Обновить метку выбранного файла
      fileInput.addEventListener("change", () => {
        fileName.textContent =
          fileInput.files.length > 0
            ? fileInput.files[0].name
            : "Файл не выбран";
      });

      // Получить и отобразить список файлов
      async function fetchFiles() {
        try {
          const response = await fetch(`${API_HOST}/files/`);
          if (!response.ok)
            throw new Error("Ошибка при получении списка файлов");
          const data = await response.json();
          filesTableBody.innerHTML = "";
          document
            .querySelectorAll(".fileSelect1, .fileSelect2")
            .forEach((select) => (select.innerHTML = ""));
          data.files
            .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
            .forEach((file) => {
              const formattedDate = new Date(file.created_at).toLocaleString(
                "ru-RU",
                {
                  day: "2-digit",
                  month: "2-digit",
                  year: "numeric",
                  hour: "2-digit",
                  minute: "2-digit",
                  second: "2-digit",
                }
              );
              const row = `<tr>
                        <td>${file.id}</td>
                        <td>${file.name}</td>
                        <td>${formattedDate}</td>
                        <td>
                            <button class="button is-danger is-small" onclick="deleteFile(${file.id})">Удалить</button>
                        </td>
                    </tr>`;
              filesTableBody.innerHTML += row;

              const option1 = document.createElement("option");
              option1.value = file.id;
              option1.textContent = `${file.name} (${formattedDate})`;
              document
                .querySelectorAll(".fileSelect1, .fileSelect2")
                .forEach((select) =>
                  select.appendChild(option1.cloneNode(true))
                );
            });
        } catch (error) {
          alert(error.message);
        }
      }

      // Загрузить файл
      uploadForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData();
        formData.append("file", fileInput.files[0]);
        try {
          const response = await fetch(`${API_HOST}/add_file/`, {
            method: "POST",
            body: formData,
          });
          if (!response.ok) throw new Error("Ошибка при загрузке файла");
          fetchFiles();
        } catch (error) {
          alert(error.message);
        }
      });

      // Удалить файл
      async function deleteFile(fileId) {
        try {
          const response = await fetch(`${API_HOST}/delete_file/${fileId}`, {
            method: "DELETE",
          });
          if (!response.ok) throw new Error("Ошибка при удалении файла");
          fetchFiles();
        } catch (error) {
          alert(error.message);
        }
      }

      // Добавить пару файлов для сравнения
      addPairButton.addEventListener("click", () => {
        const newPair = document.createElement("div");
        newPair.classList.add("pair-and-result");
        newPair.innerHTML = `
          <div class="pair-selectors">
            <div class="control">
              <div class="select">
                <select class="fileSelect1" required>
                  ${document.querySelector(".fileSelect1").innerHTML}
                </select>
              </div>
            </div>
            <div class="control">
              <div class="select">
                <select class="fileSelect2" required>
                  ${document.querySelector(".fileSelect2").innerHTML}
                </select>
              </div>
            </div>
            <button type="button" class="button is-danger is-light delete-pair-button">Удалить</button>
          </div>
        `;
        selectorsContainer.appendChild(newPair);

        newPair
          .querySelector(".delete-pair-button")
          .addEventListener("click", () => {
            newPair.remove();
          });
      });

      // Сравнить файлы
      compareForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        pairs = [];
        document.querySelectorAll(".pair-selectors").forEach((pair) => {
          const fileId1 = pair.querySelector(".fileSelect1").value;
          const fileId2 = pair.querySelector(".fileSelect2").value;
          if (fileId1 && fileId2 && fileId1 !== fileId2) {
            pairs.push({ fileId1, fileId2 });
          }
        });

        if (pairs.length === 0) {
          alert("Пожалуйста, добавьте хотя бы одну пару для сравнения");
          return;
        }

        loadingIndicator.style.display = "flex";
        compareButton.disabled = true;

        comparisonResultsBody.innerHTML = "";
        // Выбираем заголовок таблицы результатов сравнения
        const headerRow = document.querySelector(
          "#comparisonResultsContainer thead tr"
        );
        headerRow.innerHTML = "<th>Измененилось</th>";

        try {
          for (const pair of pairs) {
            const { fileId1, fileId2 } = pair;
            const response = await fetch(
              `${API_HOST}/compare_files/?file_id_1=${fileId1}&file_id_2=${fileId2}`,
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: "",
              }
            );
            if (!response.ok) throw new Error("Ошибка при сравнении файлов");
            const result = await response.json();

            // Добавление заголовка для текущей пары файлов
            const headerCell = document.createElement("th");
            headerCell.textContent = `id ${fileId1} & ${fileId2}`;
            headerRow.appendChild(headerCell);

            // Добавление результатов в таблицу
            const changes = [
              { name: "Предметов", value: result.metadata.title },
              { name: "Преподавателей", value: result.metadata.fio },
              { name: "Аудиторий", value: result.metadata.room },
              { name: "Кампусов", value: result.metadata.campus },
            ];

            changes.forEach((change, index) => {
              let row = comparisonResultsBody.children[index];
              if (!row) {
                row = document.createElement("tr");
                row.innerHTML = `<td>${change.name}</td>`;
                comparisonResultsBody.appendChild(row);
              }
              const cell = document.createElement("td");
              cell.textContent = change.value;
              row.appendChild(cell);
            });

            // Добавление кнопки для скачивания файла сравнения
            let downloadRow =
              comparisonResultsBody.querySelector(".download-row");
            if (!downloadRow) {
              downloadRow = document.createElement("tr");
              downloadRow.classList.add("download-row");
              downloadRow.innerHTML = `<td>Файл сравнения</td>`;
              comparisonResultsBody.appendChild(downloadRow);
            }
            const downloadCell = document.createElement("td");
            const downloadButton = document.createElement("a");
            downloadButton.href = result.download_url;
            downloadButton.classList.add("button", "is-small", "is-info");
            downloadButton.textContent = "Скачать";
            downloadCell.appendChild(downloadButton);
            downloadRow.appendChild(downloadCell);
          }

          // Добавление итогового заголовка "Итого"
          const totalChangesHeader = document.createElement("th");
          totalChangesHeader.textContent = "Итого";
          headerRow.appendChild(totalChangesHeader);

          // Подсчет итоговых изменений для каждой строки
          document
            .querySelectorAll("#comparisonResultsBody tr")
            .forEach((row) => {
              if (!row.classList.contains("download-row")) {
                const sum = Array.from(
                  row.querySelectorAll("td:not(:first-child)")
                )
                  .map((cell) => parseInt(cell.textContent) || 0)
                  .reduce((a, b) => a + b, 0);
                const totalCell = document.createElement("td");
                totalCell.textContent = sum;
                row.appendChild(totalCell);
              }
            });

          comparisonResultsContainer.style.display = "block";
        } catch (error) {
          alert(error.message);
        } finally {
          loadingIndicator.style.display = "none";
          compareButton.disabled = false;
        }
      });

      // Кнопка обновления списка файлов
      refreshFiles.addEventListener("click", fetchFiles);

      // Загрузить список файлов при загрузке страницы
      fetchFiles();
    </script>
  </body>
</html>
