<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.9.3/css/bulma.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
    />
    <title>Сравнение расписаний</title>
    <style>
      #loading {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      #loading .spinner {
        font-size: 3rem;
      }
      .pair-selectors {
        display: flex;
        gap: 1rem;
        align-items: center;
        margin-bottom: 1rem;
      }
      .pair-and-result {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        flex-wrap: wrap;
      }
      .selectors-box {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        flex: 1;
        min-width: 300px;
      }
      .select {
        width: 100%;
        max-width: 100%;
      }

      .select select {
        width: 100%;
        box-sizing: border-box;
      }
      .delete-pair-button {
        align-self: center;
      }
      .comparison-table {
        margin-top: 2rem;
      }
      .changes-row ul {
        list-style-type: disc;
        margin-left: 20px;
      }

      .changes-row div strong {
        display: block;
        margin-top: 10px;
      }
      .changes-container {
        max-height: 300px;
        overflow-y: auto;
      }

      .input {
        max-width: 100%;
        box-sizing: border-box;
      }

      .dropdown,
      .dropdown .dropdown-menu {
        display: none;
      }

      .field.is-grouped {
        display: flex;
        gap: 1rem;
      }

      .field.is-grouped > .control:first-child {
        flex: 0 0 auto;
      }

      .field.is-grouped > .control.is-expanded {
        flex: 1 1 auto;
        min-width: 0;
      }

      .field.has-addons {
        display: flex;
        width: 100%;
      }

      .field.has-addons .control.is-expanded {
        flex: 1 1 auto;
        min-width: 0;
      }

      .field.has-addons .control:not(.is-expanded) {
        flex: 0 0 auto;
      }
      #searchGroupButton.is-empty {
        background-color: #f14668;
        border-color: transparent;
        color: #fff;
      }

      #searchGroupButton.is-ready {
        background-color: #3298dc;
        border-color: transparent;
        color: #fff;
      }

      #searchGroupButton.is-success {
        background-color: #48c774;
        border-color: transparent;
        color: #fff;
      }
      .dropdown {
        width: 100%;
        position: relative;
        display: block;
      }

      .dropdown-menu {
        width: 100%;
        display: none;
        position: absolute;
        z-index: 20;
      }

      .dropdown.is-active .dropdown-menu {
        display: block;
      }

      .dropdown-content {
        background-color: white;
        border-radius: 4px;
        box-shadow: 0 2px 3px rgba(10, 10, 10, 0.1);
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #dbdbdb;
        margin-top: 4px;
      }

      .dropdown-item {
        display: block;
        padding: 0.375rem 1rem;
        cursor: pointer;
      }

      .dropdown-item:hover {
        background-color: #f5f5f5;
      }

      .control.is-expanded {
        position: relative;
      }
    </style>
  </head>
  <body>
    <section class="section">
      <div class="container">
        <h1 class="title">Сравнение расписаний</h1>

        <div class="box">
          <h2 class="subtitle">Загрузка файла</h2>
          <form id="uploadForm">
            <div class="field is-grouped">
              <div class="control">
                <div class="file has-name">
                  <label class="file-label">
                    <input class="file-input" type="file" id="fileInput" />
                    <span class="file-cta">
                      <span class="file-icon">
                        <i class="fas fa-upload"></i>
                      </span>
                      <span class="file-label"> Выберите файл… </span>
                    </span>
                    <span class="file-name" id="fileName">Файл не выбран</span>
                  </label>
                </div>
              </div>
              <div class="control is-expanded">
                <div class="field has-addons">
                  <div class="control is-expanded">
                    <input
                      class="input"
                      type="text"
                      id="groupSearchInput"
                      placeholder="Введите название группы"
                    />
                    <div id="groupSearchDropdown" class="dropdown">
                      <div class="dropdown-menu">
                        <div class="dropdown-content" id="groupSearchResults">
                          <!-- Search results will be populated here -->
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="control">
                    <button
                      type="button"
                      id="searchGroupButton"
                      class="button is-info"
                    >
                      Найти
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <div class="field">
              <div class="control">
                <label class="label">Ссылка на файл:</label>
                <input
                  class="input"
                  type="text"
                  id="linkInput"
                  placeholder="Введите URL для загрузки"
                />
              </div>
            </div>
            <div class="field">
              <button type="submit" class="button is-primary">Загрузить</button>
            </div>
          </form>
        </div>

        <div class="box">
          <h2 class="subtitle">Доступные файлы</h2>
          <button id="refreshFiles" class="button is-info mb-4">
            Обновить список файлов
          </button>
          <div id="fileList" class="table-container">
            <table class="table is-fullwidth">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Название</th>
                  <th>Дата создания</th>
                  <th>Действия</th>
                </tr>
              </thead>
              <tbody id="filesTableBody">
                <!-- File rows will be populated here -->
              </tbody>
            </table>
          </div>
        </div>

        <div class="box">
          <h2 class="subtitle">Сравнение файлов</h2>
          <form id="compareForm">
            <div class="selectors-box" id="selectorsContainer">
              <div class="pair-and-result">
                <div class="pair-selectors">
                  <div class="control">
                    <div class="select">
                      <select class="fileSelect1" required>
                        <!-- File options will be populated here -->
                      </select>
                    </div>
                  </div>
                  <div class="control">
                    <div class="select">
                      <select class="fileSelect2" required>
                        <!-- File options will be populated here -->
                      </select>
                    </div>
                  </div>
                  <button
                    type="button"
                    class="button is-danger is-light delete-pair-button"
                  >
                    Удалить
                  </button>
                </div>
              </div>
            </div>
            <div class="field">
              <button type="button" id="addPairButton" class="button is-info">
                Добавить еще пару
              </button>
            </div>
            <div class="field">
              <button
                type="submit"
                id="compareButton"
                class="button is-primary"
              >
                Сравнить файлы
              </button>
            </div>
          </form>
        </div>

        <div
          id="comparisonResultsContainer"
          class="box comparison-table"
          style="display: none"
        >
          <h2 class="subtitle">Результаты сравнения</h2>
          <table class="table is-fullwidth">
            <thead>
              <tr>
                <th>Количество изменений</th>
                <!-- Pair headers will be populated here -->
                <th>Итоговые изменения</th>
              </tr>
            </thead>
            <tbody id="comparisonResultsBody">
              <!-- Comparison results will be populated here -->
            </tbody>
          </table>
        </div>
      </div>
    </section>
    <div id="loading" class="has-text-centered">
      <div class="spinner">
        <i class="fas fa-spinner fa-pulse"></i>
      </div>
      <p>Идет сравнение файлов, пожалуйста, подождите...</p>
    </div>
    <script>
      const API_HOST = "{{ api_url }}";

      const fileInput = document.getElementById("fileInput");
      const fileName = document.getElementById("fileName");
      const filesTableBody = document.getElementById("filesTableBody");
      const uploadForm = document.getElementById("uploadForm");
      const compareForm = document.getElementById("compareForm");
      const compareButton = document.getElementById("compareButton");
      const refreshFiles = document.getElementById("refreshFiles");
      const loadingIndicator = document.getElementById("loading");
      const selectorsContainer = document.getElementById("selectorsContainer");
      const addPairButton = document.getElementById("addPairButton");
      const comparisonResultsContainer = document.getElementById(
        "comparisonResultsContainer"
      );
      const comparisonResultsBody = document.getElementById(
        "comparisonResultsBody"
      );
      const groupSearchInput = document.getElementById("groupSearchInput");
      const linkInput = document.getElementById("linkInput");

      // Обновить метку выбранного файла
      fileInput.addEventListener("change", () => {
        fileName.textContent =
          fileInput.files.length > 0
            ? fileInput.files[0].name
            : "Файл не выбран";
      });

      // Функция дебаунса
      function debounce(func, delay) {
        let debounceTimer;
        return function () {
          const context = this;
          const args = arguments;
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(() => func.apply(context, args), delay);
        };
      }

      // Обработчик поиска группы
      const searchGroupButton = document.getElementById("searchGroupButton");

      // New group search handler
      searchGroupButton.addEventListener("click", async () => {
        const query = groupSearchInput.value.trim();
        if (query.length === 0) {
          alert("Введите название группы");
          return;
        }

        try {
          searchGroupButton.classList.remove(
            "is-empty",
            "is-ready",
            "is-success"
          );
          searchGroupButton.classList.add("is-loading");

          const response = await fetch(
            `${API_HOST}/search_groups/?match=${encodeURIComponent(query)}`
          );
          if (!response.ok) throw new Error("Ошибка при поиске группы");
          const data = await response.json();

          if (data.data && data.data.length > 0) {
            const group = data.data[0]; // Take first match
            groupSearchInput.value = group.fullTitle;
            linkInput.value = group.iCalLink;
            selectedGroupName = group.fullTitle;
            searchGroupButton.classList.add("is-success");
          } else {
            alert("Группа не найдена");
            linkInput.value = "";
            selectedGroupName = "";
            searchGroupButton.classList.add("is-empty");
          }
        } catch (error) {
          alert("Ошибка при поиске группы: " + error.message);
          searchGroupButton.classList.add("is-empty");
        } finally {
          searchGroupButton.classList.remove("is-loading");
        }
      });

      // Закрытие выпадающего списка при клике вне его
      document.addEventListener("click", (event) => {
        if (
          !groupSearchDropdown.contains(event.target) &&
          event.target !== groupSearchInput
        ) {
          groupSearchDropdown.classList.remove("is-active");
        }
      });

      // Обработчик формы загрузки
      uploadForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        // Проверяем, какой ввод предоставлен
        if (fileInput.files.length > 0) {
          // Загрузить выбранный файл
          const formData = new FormData();
          formData.append("file", fileInput.files[0]);
          try {
            const response = await fetch(`${API_HOST}/add_file/`, {
              method: "POST",
              body: formData,
            });
            if (!response.ok) throw new Error("Ошибка при загрузке файла");
            fetchFiles();
          } catch (error) {
            alert(error.message);
          }
        } else if (linkInput.value.trim() !== "") {
          // Загрузить файл по ссылке из linkInput
          try {
            const fileBlob = await fetchFileFromUrl(linkInput.value.trim());
            const formData = new FormData();

            // Устанавливаем имя файла как {selectedGroupName}.ics, есл�� выбрана группа, иначе default.ics
            const fileName = selectedGroupName
              ? `${selectedGroupName}.ics`
              : "default.ics";
            formData.append("file", fileBlob, fileName);

            const response = await fetch(`${API_HOST}/add_file/`, {
              method: "POST",
              body: formData,
            });
            if (!response.ok) throw new Error("Ошибка при загрузке файла");
            fetchFiles();
          } catch (error) {
            alert(error.message);
          }
        } else {
          alert("Пожалуйста, выберите файл или введите ссылку для загрузки");
        }
      });

      async function fetchFileFromUrl(url) {
        try {
          const response = await fetch(url);
          if (!response.ok)
            throw new Error("Ошибка при получении файла по ссылке");
          const blob = await response.blob();
          return blob;
        } catch (error) {
          console.error(error.message);
          throw error;
        }
      }

      // Обновить метку выбранного файла
      fileInput.addEventListener("change", () => {
        fileName.textContent =
          fileInput.files.length > 0
            ? fileInput.files[0].name
            : "Файл не выбран";
      });

      // Получить и отобразить список файлов
      let pairs = [];
      async function fetchFiles() {
        try {
          const response = await fetch(`${API_HOST}/files/`);
          if (!response.ok)
            throw new Error("Ошибка при получении списка файлов");
          const data = await response.json();
          filesTableBody.innerHTML = "";
          document
            .querySelectorAll(".fileSelect1, .fileSelect2")
            .forEach((select) => (select.innerHTML = ""));
          data.files
            .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
            .forEach((file) => {
              const formattedDate = new Date(file.created_at).toLocaleString(
                "ru-RU",
                {
                  day: "2-digit",
                  month: "2-digit",
                  year: "numeric",
                  hour: "2-digit",
                  minute: "2-digit",
                  second: "2-digit",
                }
              );
              const row = `<tr>
                        <td>${file.id}</td>
                        <td>${file.name}</td>
                        <td>${formattedDate}</td>
                        <td>
                            <button class="button is-danger is-small" onclick="deleteFile(${file.id})">Удалить</button>
                        </td>
                    </tr>`;
              filesTableBody.innerHTML += row;

              const option1 = document.createElement("option");
              option1.value = file.id;
              option1.textContent = `${file.name} (${formattedDate})`;
              document
                .querySelectorAll(".fileSelect1, .fileSelect2")
                .forEach((select) =>
                  select.appendChild(option1.cloneNode(true))
                );
            });
        } catch (error) {
          alert(error.message);
        }
      }

      // Удалить файл
      async function deleteFile(fileId) {
        try {
          const response = await fetch(`${API_HOST}/delete_file/${fileId}`, {
            method: "DELETE",
          });
          if (!response.ok) throw new Error("Ошибка при удалении файла");
          fetchFiles();
        } catch (error) {
          alert(error.message);
        }
      }

      // Добавить пару файлов для сравнения
      addPairButton.addEventListener("click", () => {
        const newPair = document.createElement("div");
        newPair.classList.add("pair-and-result");
        newPair.innerHTML = `
          <div class="pair-selectors">
            <div class="control">
              <div class="select">
                <select class="fileSelect1" required>
                  ${document.querySelector(".fileSelect1").innerHTML}
                </select>
              </div>
            </div>
            <div class="control">
              <div class="select">
                <select class="fileSelect2" required>
                  ${document.querySelector(".fileSelect2").innerHTML}
                </select>
              </div>
            </div>
            <button type="button" class="button is-danger is-light delete-pair-button">Удалить</button>
          </div>
        `;
        selectorsContainer.appendChild(newPair);

        newPair
          .querySelector(".delete-pair-button")
          .addEventListener("click", () => {
            newPair.remove();
          });
      });

      // Сравнить файлы
      compareForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        pairs = [];
        document.querySelectorAll(".pair-selectors").forEach((pair) => {
          const fileId1 = pair.querySelector(".fileSelect1").value;
          const fileId2 = pair.querySelector(".fileSelect2").value;
          if (fileId1 && fileId2 && fileId1 !== fileId2) {
            pairs.push({ fileId1, fileId2 });
          }
        });

        if (pairs.length === 0) {
          alert("Пожалуйста, добавьте хотя бы одну пару для сравнения");
          return;
        }

        loadingIndicator.style.display = "flex";
        compareButton.disabled = true;

        comparisonResultsBody.innerHTML = "";
        // Выбираем заголовок таблицы результатов сравнения
        const headerRow = document.querySelector(
          "#comparisonResultsContainer thead tr"
        );
        headerRow.innerHTML = "<th>Количество изменений</th>";

        try {
          for (const pair of pairs) {
            const { fileId1, fileId2 } = pair;
            const response = await fetch(
              `${API_HOST}/compare_files/?file_id_1=${fileId1}&file_id_2=${fileId2}`,
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: "",
              }
            );
            if (!response.ok) throw new Error("Ошибка при сравнении файлов");
            const result = await response.json();

            // Добавление заголовка для текущей пары файлов
            const headerCell = document.createElement("th");
            headerCell.textContent = `id ${fileId1} & ${fileId2}`;
            headerRow.appendChild(headerCell);

            // Добавление результатов в таблицу
            const changesData = [
              { name: "Предметов", value: result.metadata.title },
              { name: "Преподавателей", value: result.metadata.fio },
              { name: "Аудиторий", value: result.metadata.room },
              { name: "Кампусов", value: result.metadata.campus },
            ];

            // Обработка каждого типа изменений
            changesData.forEach((change, index) => {
              let row = comparisonResultsBody.children[index];
              if (!row) {
                row = document.createElement("tr");
                row.innerHTML = `<td>${change.name}</td>`;
                comparisonResultsBody.appendChild(row);
              }
              const cell = document.createElement("td");
              cell.textContent = change.value;
              row.appendChild(cell);
            });

            // Обработка детальных изменений
            const detailedChanges = result.metadata.changes || {};
            let changesRowIndex = changesData.length; // Индекс для строки с изменениями
            let changesRow = comparisonResultsBody.children[changesRowIndex];
            if (!changesRow) {
              changesRow = document.createElement("tr");
              changesRow.classList.add("changes-row");
              changesRow.innerHTML = `<td>Изменения</td>`;
              comparisonResultsBody.appendChild(changesRow);
            }
            const changesCell = document.createElement("td");

            // Если есть изменения, добавляем кнопку для показа/скрытия
            if (Object.keys(detailedChanges).length > 0) {
              const button = document.createElement("button");
              button.classList.add("button", "is-small");
              button.textContent = "Показать изменения";
              changesCell.appendChild(button);

              const changesContainer = document.createElement("div");
              changesContainer.classList.add("changes-container");
              changesContainer.style.display = "none";
              changesContainer.style.marginTop = "10px";

              // Создаем список изменений
              Object.keys(detailedChanges).forEach((group) => {
                const groupDiv = document.createElement("div");
                const groupHeader = document.createElement("strong");
                groupHeader.textContent = group;
                groupDiv.appendChild(groupHeader);

                const days = detailedChanges[group];
                // Check if days is a string (missing group message) or an object (lesson changes)
                if (typeof days === 'string') {
                    const messageDiv = document.createElement("div");
                    messageDiv.style.marginLeft = "15px";
                    messageDiv.textContent = days;
                    groupDiv.appendChild(messageDiv);
                } else {
                    Object.keys(days).forEach((day) => {
                        const dayDiv = document.createElement("div");
                        dayDiv.style.marginLeft = "15px";
                        const dayHeader = document.createElement("strong");
                        dayHeader.textContent = day;
                        dayDiv.appendChild(dayHeader);

                        const lessons = days[day];
                        Object.keys(lessons).forEach((lesson) => {
                            const lessonDiv = document.createElement("div");
                            lessonDiv.style.marginLeft = "30px";
                            const lessonHeader = document.createElement("strong");
                            lessonHeader.textContent = `Пара ${lesson}`;
                            lessonDiv.appendChild(lessonHeader);

                            const changesList = document.createElement("ul");
                            changesList.style.marginLeft = "45px";
                            
                            // Handle both array and string cases for lesson changes
                            if (Array.isArray(lessons[lesson])) {
                                lessons[lesson].forEach((changeText) => {
                                    const li = document.createElement("li");
                                    li.textContent = changeText;
                                    changesList.appendChild(li);
                                });
                            } else {
                                const li = document.createElement("li");
                                li.textContent = lessons[lesson];
                                changesList.appendChild(li);
                            }
                            
                            lessonDiv.appendChild(changesList);
                            dayDiv.appendChild(lessonDiv);
                        });
                        groupDiv.appendChild(dayDiv);
                    });
                }
                changesContainer.appendChild(groupDiv);
            });

              changesCell.appendChild(changesContainer);

              button.addEventListener("click", () => {
                if (changesContainer.style.display === "none") {
                  changesContainer.style.display = "block";
                  button.textContent = "Скрыть изменения";
                } else {
                  changesContainer.style.display = "none";
                  button.textContent = "Показать изменения";
                }
              });
            } else {
              // Если изменений нет, отображаем соответствующее сообщение
              changesCell.textContent = "Нет изменений";
            }

            changesRow.appendChild(changesCell);

            // Добавление кнопки для скачивания файла сравнения
            let downloadRow =
              comparisonResultsBody.querySelector(".download-row");
            if (!downloadRow) {
              downloadRow = document.createElement("tr");
              downloadRow.classList.add("download-row");
              downloadRow.innerHTML = `<td>Файл сравнения</td>`;
              comparisonResultsBody.appendChild(downloadRow);
            }

            const downloadCell = document.createElement("td");
            const downloadButton = document.createElement("a");
            downloadButton.classList.add("button", "is-small", "is-info");
            if (result.download_url) {
              downloadButton.href = result.download_url;
              downloadButton.textContent = "Скачать";
            } else {
              downloadButton.textContent = "-";
              downloadButton.classList.add("is-static"); // Делает кнопку неактивной
            }
            downloadCell.appendChild(downloadButton);
            downloadRow.appendChild(downloadCell);
          }

          // Добавление итогового заголовка "Итого"
          const totalChangesHeader = document.createElement("th");
          totalChangesHeader.textContent = "Итого";
          headerRow.appendChild(totalChangesHeader);

          // Подсчет итоговых изменений для каждой строки
          document
            .querySelectorAll("#comparisonResultsBody tr")
            .forEach((row) => {
              if (
                !row.classList.contains("download-row") &&
                !row.classList.contains("changes-row")
              ) {
                const sum = Array.from(
                  row.querySelectorAll("td:not(:first-child)")
                )
                  .map((cell) => parseInt(cell.textContent) || 0)
                  .reduce((a, b) => a + b, 0);
                const totalCell = document.createElement("td");
                totalCell.textContent = sum;
                row.appendChild(totalCell);
              } else {
                const totalCell = document.createElement("td");
                totalCell.textContent = "";
                row.appendChild(totalCell);
              }
            });

          comparisonResultsContainer.style.display = "block";
        } catch (error) {
          alert(error.message);
        } finally {
          loadingIndicator.style.display = "none";
          compareButton.disabled = false;
        }
      });

      // Кнопка обновления списка файлов
      refreshFiles.addEventListener("click", fetchFiles);

      // Загрузить список файлов при загрузке страницы
      fetchFiles();

      // Update search button initially to empty state
      searchGroupButton.classList.add("is-empty");

      // Add input handler for group search
      groupSearchInput.addEventListener("input", () => {
        if (groupSearchInput.value.trim().length > 0) {
          searchGroupButton.classList.remove("is-empty");
          searchGroupButton.classList.add("is-ready");
        } else {
          searchGroupButton.classList.remove("is-ready", "is-success");
          searchGroupButton.classList.add("is-empty");
        }
      });

      // Update search functionality
      searchGroupButton.classList.add("is-empty");
      searchGroupButton.disabled = true; // Initially disable button

      // Debounced search function
      const debouncedSearch = debounce(async (query) => {
        const dropdownContent = document.getElementById("groupSearchResults");
        const dropdown = document.getElementById("groupSearchDropdown");

        if (!query.trim()) {
          searchGroupButton.classList.remove("is-ready", "is-success");
          searchGroupButton.classList.add("is-empty");
          searchGroupButton.disabled = true;
          linkInput.value = "";
          dropdown.classList.remove("is-active");
          return;
        }

        try {
          searchGroupButton.classList.add("is-loading");
          const response = await fetch(
            `${API_HOST}/search_groups/?match=${encodeURIComponent(query)}`
          );
          if (!response.ok) throw new Error("Ошибка при поиске группы");
          const data = await response.json();

          if (data.data && data.data.length > 0) {
            // Populate dropdown with results
            dropdownContent.innerHTML = data.data
              .map(
                (group) => `
              <a class="dropdown-item" data-group='${JSON.stringify(group)}'>
                ${group.fullTitle}
              </a>
            `
              )
              .join("");

            dropdown.classList.add("is-active");

            // Add click handlers for dropdown items
            dropdownContent
              .querySelectorAll(".dropdown-item")
              .forEach((item) => {
                item.addEventListener("click", (e) => {
                  const groupData = JSON.parse(e.target.dataset.group);
                  groupSearchInput.value = groupData.fullTitle;
                  linkInput.value = groupData.iCalLink;
                  selectedGroupName = groupData.fullTitle;
                  dropdown.classList.remove("is-active");
                  searchGroupButton.classList.remove("is-empty", "is-loading");
                  searchGroupButton.classList.add("is-success");
                });
              });

            searchGroupButton.classList.remove("is-empty", "is-loading");
            searchGroupButton.classList.add("is-ready");
            searchGroupButton.disabled = false;
          } else {
            dropdownContent.innerHTML =
              '<div class="dropdown-item">Группы не найдены</div>';
            dropdown.classList.add("is-active");
            searchGroupButton.classList.remove(
              "is-ready",
              "is-success",
              "is-loading"
            );
            searchGroupButton.classList.add("is-empty");
            searchGroupButton.disabled = true;
            linkInput.value = "";
          }
        } catch (error) {
          searchGroupButton.classList.remove(
            "is-ready",
            "is-success",
            "is-loading"
          );
          searchGroupButton.classList.add("is-empty");
          searchGroupButton.disabled = true;
          linkInput.value = "";
          dropdown.classList.remove("is-active");
        }
      }, 300);

      // Add click outside handler to close dropdown
      document.addEventListener("click", (e) => {
        const dropdown = document.getElementById("groupSearchDropdown");
        if (
          !dropdown.contains(e.target) &&
          !groupSearchInput.contains(e.target)
        ) {
          dropdown.classList.remove("is-active");
        }
      });

      // Live search handler
      groupSearchInput.addEventListener("input", (e) => {
        const query = e.target.value.trim();
        debouncedSearch(query);
      });

      // Update button click handler
      searchGroupButton.addEventListener("click", () => {
        const groupData = JSON.parse(
          searchGroupButton.dataset.groupData || "{}"
        );
        if (groupData.fullTitle) {
          groupSearchInput.value = groupData.fullTitle;
          linkInput.value = groupData.iCalLink;
          selectedGroupName = groupData.fullTitle;
        }
      });
    </script>
  </body>
</html>
