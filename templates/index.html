<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.9.3/css/bulma.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
    />
    <link rel="stylesheet" href="{{ base_url }}/static/css/common.css" />
    <link rel="stylesheet" href="{{ base_url }}/static/css/pages.css" />
    <title>Сравнение расписаний</title>
  </head>
  <body>
    <!-- Навигация -->
    <nav class="navbar is-light" role="navigation" aria-label="main navigation">
      <div class="navbar-menu">
        <div class="navbar-start">
          <a
            class="navbar-item {% if request.url.path == '/' %}is-active{% endif %}"
            href="{{ request.scope.root_path }}/"
          >
            Сравнение расписаний
          </a>
          <a
            class="navbar-item {% if request.url.path == '/schedule' %}is-active{% endif %}"
            href="{{ request.scope.root_path }}/schedule"
          >
            Просмотр расписания
          </a>
        </div>
        <div class="navbar-end">
          <div class="navbar-item theme-toggle-wrapper">
            <button class="button theme-toggle" onclick="toggleTheme()">
              <span class="icon"><i class="fas fa-moon"></i></span>
            </button>
          </div>
        </div>
      </div>
    </nav>

    <!-- Основной контент -->
    <section class="section">
      <div class="container">
        <h1 class="title">Сравнение расписаний</h1>

        <div class="columns">
          <!-- Groups Column -->
          <div class="column">
            <div class="box">
              <h2 class="subtitle">Группы</h2>
              <div id="selectedGroupsList">
                <p class="has-text-grey">Список групп пуст</p>
              </div>
              <div class="search-container field has-addons">
                <div class="control is-expanded" style="position: relative">
                  <input
                    type="text"
                    id="groupSearchInput"
                    class="input"
                    placeholder="Введите название группы..."
                  />
                  <div id="groupSearchDropdown" class="dropdown">
                    <div class="dropdown-menu">
                      <div
                        class="dropdown-content"
                        id="groupSearchResults"
                      ></div>
                    </div>
                  </div>
                </div>
                <div class="control">
                  <button id="addSelectedGroupButton" class="button is-primary">
                    <span class="icon">
                      <i class="fas fa-plus"></i>
                    </span>
                    <span>Добавить</span>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Versions Column -->
          <div class="column">
            <div class="box">
              <h2 class="subtitle">Версии</h2>
              <div id="versionsList">
                <p class="has-text-grey">Список версий пуст</p>
              </div>
              <div class="field">
                <button
                  id="downloadGroupsButton"
                  class="button is-primary is-fullwidth"
                >
                  <span class="icon"><i class="fas fa-download"></i></span>
                  <span>Скачать группы</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Version Comparison -->
        <div class="box">
          <h2 class="subtitle">Сравнение версий</h2>
          <div class="columns">
            <div class="column">
              <div class="field">
                <label class="label">Левая версия</label>
                <div class="control">
                  <div class="select is-fullwidth">
                    <select id="leftVersionSelect">
                      <option value="">Нет версий</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
            <div class="column">
              <div class="field">
                <label class="label">Правая версия</label>
                <div class="control">
                  <div class="select is-fullwidth">
                    <select id="rightVersionSelect">
                      <option value="">Нет версий</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="field">
            <button
              id="compareVersionsButton"
              class="button is-info is-fullwidth"
            >
              Сравнить версии
            </button>
          </div>
          <div id="comparisonResults" style="display: none">
            <table class="table is-fullwidth">
              <thead>
                <tr>
                  <th>Группа</th>
                  <th>Отличий</th>
                  <th>Подробности</th>
                </tr>
              </thead>
              <tbody id="comparisonResultsBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- Loading Modal -->
    <div id="loading" class="modal">
      <div class="modal-background"></div>
      <div class="modal-content has-text-centered">
        <span class="icon is-large">
          <i class="fas fa-spinner fa-pulse fa-3x"></i>
        </span>
        <p style="color: white">Пожалуйста, подождите...</p>
      </div>
    </div>

    <!-- Скрипты -->
    <script>
      const API_HOST = "{{ base_url }}/api";

      function toggleTheme() {
        const theme =
          document.documentElement.getAttribute("data-theme") === "dark"
            ? "light"
            : "dark";
        document.documentElement.setAttribute("data-theme", theme);
        localStorage.setItem("theme", theme);
        updateThemeIcon();
      }

      function updateThemeIcon() {
        const icon = document.querySelector(".theme-toggle .icon i");
        if (document.documentElement.getAttribute("data-theme") === "dark") {
          icon.classList.remove("fa-moon");
          icon.classList.add("fa-sun");
        } else {
          icon.classList.remove("fa-sun");
          icon.classList.add("fa-moon");
        }
      }

      const savedTheme = localStorage.getItem("theme") || "light";
      document.documentElement.setAttribute("data-theme", savedTheme);
      window.addEventListener("DOMContentLoaded", updateThemeIcon);

      let versions = [];
      let selectedGroups = [];

      async function fetchVersions() {
        try {
          const response = await fetch(`${API_HOST}/files/`);
          if (!response.ok)
            throw new Error("Ошибка при получении списка версий");
          const data = await response.json();
          versions = data.files;
          renderVersions();
          renderVersionOptions();
        } catch (error) {
          console.error(error);
          alert(error.message);
        }
      }

      const selectedGroupsList = document.getElementById("selectedGroupsList");
      const groupSearchInput = document.getElementById("groupSearchInput");
      const groupSearchDropdown = document.getElementById(
        "groupSearchDropdown"
      );
      const groupSearchResults = document.getElementById("groupSearchResults");
      const addSelectedGroupButton = document.getElementById(
        "addSelectedGroupButton"
      );

      function renderSelectedGroups() {
        selectedGroupsList.innerHTML = "";
        if (selectedGroups.length === 0) {
          selectedGroupsList.innerHTML =
            '<p class="has-text-grey">Список групп пуст</p>';
          return;
        }
        selectedGroups.forEach((group, index) => {
          const tag = document.createElement("span");
          tag.className = "tag is-info is-medium";
          tag.textContent = group.fullTitle;
          tag.style.marginRight = "1rem";
          tag.style.marginTop = "1rem";
          const deleteBtn = document.createElement("button");
          deleteBtn.className = "delete is-small";
          deleteBtn.style.marginLeft = "0.5rem";
          deleteBtn.addEventListener("click", () => {
            selectedGroups.splice(index, 1);
            renderSelectedGroups();
          });
          tag.appendChild(deleteBtn);
          selectedGroupsList.appendChild(tag);
        });
      }

      function debounce(func, delay) {
        let timeout;
        return function (...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), delay);
        };
      }

      async function searchGroups(query) {
        if (!query.trim()) {
          groupSearchDropdown.classList.remove("is-active");
          clearSearchResults();
          return;
        }
        try {
          const response = await fetch(
            `${API_HOST}/search_groups/?match=${encodeURIComponent(query)}`
          );
          if (!response.ok) throw new Error("Ошибка поиска групп");
          const data = await response.json();
          if (data.data && data.data.length > 0) {
            groupSearchResults.innerHTML = data.data
              .map((group) => {
                const minGroup = {
                  id: group.id,
                  fullTitle: group.fullTitle,
                };
                return `<a class="dropdown-item" data-group='${JSON.stringify(
                  minGroup
                )}'>${group.fullTitle}</a>`;
              })
              .join("");
            groupSearchDropdown.classList.add("is-active");

            document
              .querySelectorAll("#groupSearchResults .dropdown-item")
              .forEach((item) => {
                item.addEventListener("click", (e) => {
                  e.preventDefault();
                  const group = JSON.parse(item.getAttribute("data-group"));
                  groupSearchInput.value = group.fullTitle;
                  selectedGroupToAdd = group;
                  updateAddButtonState();
                  groupSearchDropdown.classList.remove("is-active");
                });
              });
          } else {
            groupSearchResults.innerHTML =
              '<div class="dropdown-item">Группы не найдены</div>';
            groupSearchDropdown.classList.add("is-active");
            clearSearchResults();
          }
        } catch (error) {
          console.error(error);
          clearSearchResults();
        }
      }

      const debouncedSearchGroups = debounce(searchGroups, 300);
      groupSearchInput.addEventListener("input", (e) => {
        debouncedSearchGroups(e.target.value);
      });

      document.addEventListener("click", (e) => {
        if (
          !groupSearchDropdown.contains(e.target) &&
          e.target !== groupSearchInput
        ) {
          groupSearchDropdown.classList.remove("is-active");
        }
      });

      let selectedGroupToAdd = null;

      function updateAddButtonState() {
        addSelectedGroupButton.disabled = !selectedGroupToAdd;
      }

      function clearSearchResults() {
        selectedGroupToAdd = null;
        updateAddButtonState();
        const activeItems = document.querySelectorAll(
          ".dropdown-item.is-active"
        );
        activeItems.forEach((item) => item.classList.remove("is-active"));
      }

      addSelectedGroupButton.addEventListener("click", () => {
        if (
          selectedGroupToAdd &&
          !selectedGroups.find(
            (g) => g.fullTitle === selectedGroupToAdd.fullTitle
          )
        ) {
          selectedGroups.push(selectedGroupToAdd);
          renderSelectedGroups();
          groupSearchInput.value = "";
          groupSearchDropdown.classList.remove("is-active");
          clearSearchResults();
        }
      });

      const versionsList = document.getElementById("versionsList");
      const leftVersionSelect = document.getElementById("leftVersionSelect");
      const rightVersionSelect = document.getElementById("rightVersionSelect");
      const downloadGroupsButton = document.getElementById(
        "downloadGroupsButton"
      );

      async function deleteVersion(versionId) {
        if (!confirm("Вы уверены, что хотите удалить эту версию?")) {
          return;
        }

        showLoading();
        try {
          const response = await fetch(`${API_HOST}/files/${versionId}`, {
            method: "DELETE",
          });
          if (!response.ok) throw new Error("Ошибка при удалении версии");
          await fetchVersions();
        } catch (error) {
          alert(error.message);
        } finally {
          hideLoading();
        }
      }

      function renderVersions() {
        versionsList.innerHTML = "";
        if (versions.length === 0) {
          versionsList.innerHTML =
            '<p class="has-text-grey">Список версий пуст</p>';
          return;
        }
        versions
          .slice()
          .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
          .forEach((version) => {
            const box = document.createElement("div");
            box.className = "version-box box";
            const date = new Date(version.created_at).toLocaleString("ru-RU");
            box.innerHTML = `
            <div class="version-info">
              <span class="version-date">${date}</span>
              <span class="version-count">${version.group_count} групп</span>
            </div>
            <button class="version-delete" title="Удалить версию" onclick="deleteVersion('${version.id}')">
              <i class="fas fa-times"></i>
            </button>
          `;
            versionsList.appendChild(box);
          });
      }

      function renderVersionOptions() {
        leftVersionSelect.innerHTML = "";
        rightVersionSelect.innerHTML = "";

        if (versions.length === 0) {
          leftVersionSelect.innerHTML = '<option value="">Нет версий</option>';
          rightVersionSelect.innerHTML = '<option value="">Нет версий</option>';
          return;
        }

        const sortedVersions = versions
          .slice()
          .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

        sortedVersions.forEach((version) => {
          const date = new Date(version.created_at).toLocaleString("ru-RU");
          const option = document.createElement("option");
          option.value = version.id;
          option.textContent = `${date} (${version.group_count} групп)`;

          leftVersionSelect.appendChild(option.cloneNode(true));
          rightVersionSelect.appendChild(option.cloneNode(true));
        });

        if (sortedVersions.length >= 2) {
          rightVersionSelect.value = sortedVersions[0].id;
          leftVersionSelect.value = sortedVersions[1].id;
        } else if (sortedVersions.length === 1) {
          rightVersionSelect.value = sortedVersions[0].id;
        }
      }

      downloadGroupsButton.addEventListener("click", async () => {
        if (selectedGroups.length === 0) {
          alert("Сначала выберите группы");
          return;
        }
        showLoading();
        try {
          const groupsArray = selectedGroups.map((group) => group.fullTitle);
          const response = await fetch(`${API_HOST}/download_groups/`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ groups: groupsArray }),
          });
          if (!response.ok) throw new Error("Ошибка при загрузке групп");
          await response.json();
          await fetchVersions();
        } catch (error) {
          alert(error.message);
        } finally {
          hideLoading();
        }
      });

      const compareVersionsButton = document.getElementById(
        "compareVersionsButton"
      );
      const comparisonResults = document.getElementById("comparisonResults");
      const comparisonResultsBody = document.getElementById(
        "comparisonResultsBody"
      );

      compareVersionsButton.addEventListener("click", async () => {
        const leftVersionId = leftVersionSelect.value;
        const rightVersionId = rightVersionSelect.value;
        if (!leftVersionId || !rightVersionId) {
          alert("Выберите обе версии для сравнения");
          return;
        }
        if (leftVersionId === rightVersionId) {
          alert("Выберите разные версии для сравнения");
          return;
        }
        showLoading();
        try {
          const response = await fetch(
            `${API_HOST}/compare_files/?file_id_1=${leftVersionId}&file_id_2=${rightVersionId}`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: "",
            }
          );
          if (!response.ok) throw new Error("Ошибка при сравнении версий");
          const result = await response.json();
          renderComparisonResults(result);
        } catch (error) {
          alert(error.message);
        } finally {
          hideLoading();
        }
      });

      function renderComparisonResults(result) {
        comparisonResultsBody.innerHTML = "";

        const sortedGroups = Object.entries(result.groups).sort(
          ([, a], [, b]) => b.total - a.total
        );

        sortedGroups.forEach(([groupName, groupData], index) => {
          const tr = document.createElement("tr");
          tr.className = "group-row";
          tr.dataset.detailsId = `details-${index}`;

          tr.innerHTML = `
              <td>
                  ${
                    groupData.total
                      ? `<span class="icon toggle-icon"><i class="fas fa-chevron-right"></i></span>`
                      : ""
                  }
                  ${groupName}
              </td>
              <td class="${groupData.total ? "has-changes" : "no-changes"}">
                  ${
                    groupData.total
                      ? `${groupData.total} изменений`
                      : "Нет изменений"
                  }
              </td>
              <td>${renderSummaryBadges(groupData.summary)}</td>
          `;

          comparisonResultsBody.appendChild(tr);

          if (groupData.total > 0) {
            const detailsRow = document.createElement("tr");
            detailsRow.className = "details-row";
            detailsRow.id = `details-${index}`;
            const detailsCell = document.createElement("td");
            detailsCell.colSpan = 3;

            const detailsContent = document.createElement("div");
            detailsContent.className = "change-details";

            if (groupData.details.added.length > 0) {
              detailsContent.appendChild(
                renderChangeSection(
                  "Добавленные пары",
                  groupData.details.added,
                  "added"
                )
              );
            }
            if (groupData.details.removed.length > 0) {
              detailsContent.appendChild(
                renderChangeSection(
                  "Удаленные пары",
                  groupData.details.removed,
                  "removed"
                )
              );
            }
            if (groupData.details.modified.length > 0) {
              detailsContent.appendChild(
                renderChangeSection(
                  "Измененные пары",
                  groupData.details.modified,
                  "modified"
                )
              );
            }

            detailsCell.appendChild(detailsContent);
            detailsRow.appendChild(detailsCell);
            comparisonResultsBody.appendChild(detailsRow);

            tr.addEventListener("click", function () {
              const detailsRow = document.getElementById(
                this.dataset.detailsId
              );
              const isVisible = detailsRow.classList.contains("is-visible");

              document.querySelectorAll(".details-row").forEach((row) => {
                row.classList.remove("is-visible");
              });
              document.querySelectorAll(".group-row").forEach((row) => {
                row.classList.remove("is-expanded");
              });

              if (!isVisible) {
                detailsRow.classList.add("is-visible");
                this.classList.add("is-expanded");
              }
            });
          }
        });

        comparisonResults.style.display = "block";
      }

      function renderSummaryBadges(summary) {
        const badges = [];
        const labels = {
          subject: "предметы",
          teacher: "преподаватели",
          room: "аудитории",
          campus: "кампусы",
        };

        for (const [key, count] of Object.entries(summary)) {
          if (count > 0) {
            badges.push(`
                  <span class="tag is-info is-light">
                      ${labels[key]}: ${count}
                  </span>
              `);
          }
        }

        return badges.join(" ");
      }

      function getWeekTypeLabel(type) {
        return type === "odd" ? "нечётная неделя" : "чётная неделя";
      }

      function renderChangeSection(title, items, type) {
        const section = document.createElement("div");
        section.className = "change-section";

        const heading = document.createElement("h3");
        heading.className = "subtitle is-5";
        heading.textContent = title;
        section.appendChild(heading);

        items.forEach((item) => {
          const card = document.createElement("div");
          card.className = "change-card";

          const header = document.createElement("div");
          header.className = "change-header";
          header.innerHTML = `
          <div>
            <strong>${item.day}</strong>
            <span class="lesson-info">
              ${item.lesson.replace(/\((odd|even)\)/, "")}
              <span class="week-type">${getWeekTypeLabel(
                item.lesson.includes("odd") ? "odd" : "even"
              )}</span>
            </span>
          </div>
        `;

          if (type === "modified") {
            card.appendChild(header);
            card.innerHTML += `
            <div class="changes-table">
              <table class="table is-fullwidth">
                <thead>
                  <tr>
                    <th>Поле</th>
                    <th>Было</th>
                    <th>Стало</th>
                  </tr>
                </thead>
                <tbody>
                  ${item.changes
                    .map(
                      (change) => `
                    <tr>
                      <td>${translateField(change.field)}</td>
                      <td class="old-value">${change.from}</td>
                      <td class="new-value">${change.to}</td>
                    </tr>
                  `
                    )
                    .join("")}
                </tbody>
              </table>
            </div>
          `;
          } else {
            card.appendChild(header);
            card.innerHTML += `
            <div class="schedule-item">
              <div><strong>Предмет:</strong> ${item.details.subject}</div>
              <div><strong>Преподаватель:</strong> ${item.details.teacher}</div>
              <div><strong>Аудитория:</strong> ${item.details.room}</div>
              <div><strong>Кампус:</strong> ${item.details.campus}</div>
            </div>
          `;
          }

          section.appendChild(card);
        });

        return section;
      }

      function translateField(field) {
        const translations = {
          subject: "Предмет",
          teacher: "Преподаватель",
          room: "Аудитория",
          campus: "Кампус",
        };
        return translations[field] || field;
      }

      const loadingModal = document.getElementById("loading");
      function showLoading() {
        loadingModal.classList.add("is-active");
      }
      function hideLoading() {
        loadingModal.classList.remove("is-active");
      }

      document.addEventListener("DOMContentLoaded", () => {
        const savedTheme = localStorage.getItem("theme") || "light";
        document.documentElement.setAttribute("data-theme", savedTheme);
        updateThemeIcon();
        fetchVersions();
      });
    </script>
  </body>
</html>
